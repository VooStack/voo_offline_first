# üß™ Testing Guide for Offline First Package

This directory contains comprehensive tests for the Offline First Flutter package. The test suite covers unit tests, widget tests, integration tests, and performance benchmarks.

## üìã Test Structure

```
test/
‚îú‚îÄ‚îÄ README.md                          # This file
‚îú‚îÄ‚îÄ test_all.dart                      # Main test runner
‚îú‚îÄ‚îÄ pubspec_additions.yaml             # Additional test dependencies
‚îú‚îÄ‚îÄ Makefile.test                      # Test automation commands
‚îÇ
‚îú‚îÄ‚îÄ models/                            # Model tests
‚îÇ   ‚îú‚îÄ‚îÄ sync_item_test.dart           # SyncItem model tests
‚îÇ   ‚îî‚îÄ‚îÄ upload_status_test.dart       # UploadStatus model tests
‚îÇ
‚îú‚îÄ‚îÄ utils/                             # Utility tests
‚îÇ   ‚îú‚îÄ‚îÄ sync_utils_test.dart          # SyncUtils helper tests
‚îÇ   ‚îî‚îÄ‚îÄ retry_policy_test.dart        # Retry policy tests
‚îÇ
‚îú‚îÄ‚îÄ services/                          # Service layer tests
‚îÇ   ‚îú‚îÄ‚îÄ connectivity_service_test.dart # Connectivity service tests
‚îÇ   ‚îî‚îÄ‚îÄ sync_manager_test.dart        # Sync manager tests
‚îÇ
‚îú‚îÄ‚îÄ repositories/                      # Repository tests
‚îÇ   ‚îî‚îÄ‚îÄ base_offline_repository_test.dart # Base repository tests
‚îÇ
‚îú‚îÄ‚îÄ bloc/                              # BLoC tests
‚îÇ   ‚îî‚îÄ‚îÄ sync_bloc_test.dart           # Sync BLoC tests
‚îÇ
‚îú‚îÄ‚îÄ widgets/                           # Widget tests
‚îÇ   ‚îî‚îÄ‚îÄ sync_status_widgets_test.dart # UI component tests
‚îÇ
‚îú‚îÄ‚îÄ exceptions/                        # Exception tests
‚îÇ   ‚îî‚îÄ‚îÄ offline_exceptions_test.dart  # Custom exception tests
‚îÇ
‚îú‚îÄ‚îÄ integration/                       # Integration tests
‚îÇ   ‚îî‚îÄ‚îÄ offline_sync_integration_test.dart # End-to-end tests
‚îÇ
‚îú‚îÄ‚îÄ performance/                       # Performance tests
‚îÇ   ‚îî‚îÄ‚îÄ performance_test.dart         # Benchmarks and stress tests
‚îÇ
‚îú‚îÄ‚îÄ mocks/                            # Mock implementations
‚îÇ   ‚îî‚îÄ‚îÄ mock_implementations.dart     # Test doubles and mocks
‚îÇ
‚îî‚îÄ‚îÄ helpers/                          # Test utilities
    ‚îî‚îÄ‚îÄ test_helpers.dart             # Common test helpers
```

## üöÄ Quick Start

### Prerequisites

Add these dependencies to your `pubspec.yaml`:

```yaml
dev_dependencies:
  flutter_test:
    sdk: flutter
  bloc_test: ^9.1.2
  mocktail: ^0.3.0
  fake_async: ^1.3.1
```

### Running Tests

**Run all tests:**
```bash
flutter test
```

**Run specific test categories:**
```bash
# Unit tests only
flutter test test/models/ test/utils/ test/services/

# Widget tests only
flutter test test/widgets/

# Integration tests only
flutter test test/integration/

# Performance tests only
flutter test test/performance/
```

**Using the Makefile:**
```bash
# Run all tests
make test

# Run with coverage
make test-coverage

# Run in watch mode
make test-watch

# See all available commands
make test-help
```

## üìä Test Categories

### 1. Model Tests (`test/models/`)

Tests for data models and their serialization:

- **SyncItem Tests**: Serialization, deserialization, copy operations, validation
- **UploadStatus Tests**: State transitions, progress tracking, error handling

**Coverage:**
- ‚úÖ JSON serialization/deserialization
- ‚úÖ Equality and hash code
- ‚úÖ Copy operations
- ‚úÖ Field validation
- ‚úÖ State transitions

### 2. Utility Tests (`test/utils/`)

Tests for helper classes and utilities:

- **SyncUtils Tests**: File operations, priority calculations, dependency sorting
- **RetryPolicy Tests**: Exponential backoff, linear backoff, smart retry logic

**Coverage:**
- ‚úÖ File validation and checksum calculation
- ‚úÖ Priority-based sorting algorithms
- ‚úÖ Dependency resolution (topological sort)
- ‚úÖ Retry timing calculations
- ‚úÖ Error classification (retryable vs non-retryable)

### 3. Service Tests (`test/services/`)

Tests for core services:

- **ConnectivityService Tests**: Network monitoring, connection quality, state changes
- **SyncManager Tests**: Queue management, sync operations, retry logic

**Coverage:**
- ‚úÖ Connectivity detection and monitoring
- ‚úÖ Sync queue management
- ‚úÖ Automatic and manual sync operations
- ‚úÖ Error handling and recovery
- ‚úÖ Progress tracking and statistics

### 4. Repository Tests (`test/repositories/`)

Tests for data access layer:

- **BaseOfflineRepository Tests**: CRUD operations, sync queue integration, stream operations

**Coverage:**
- ‚úÖ Entity CRUD operations
- ‚úÖ Sync queue integration
- ‚úÖ Upload status tracking
- ‚úÖ Stream-based reactive updates
- ‚úÖ Batch operations
- ‚úÖ Error handling

### 5. BLoC Tests (`test/bloc/`)

Tests for state management:

- **SyncBloc Tests**: Event handling, state transitions, side effects

**Coverage:**
- ‚úÖ Event processing
- ‚úÖ State transitions
- ‚úÖ Side effect management
- ‚úÖ Error state handling
- ‚úÖ Stream subscriptions

### 6. Widget Tests (`test/widgets/`)

Tests for UI components:

- **SyncStatusWidgets Tests**: UI component behavior, user interactions, state display

**Coverage:**
- ‚úÖ Widget rendering
- ‚úÖ User interaction handling
- ‚úÖ State-based UI updates
- ‚úÖ Accessibility features
- ‚úÖ Theme integration

### 7. Exception Tests (`test/exceptions/`)

Tests for error handling:

- **OfflineExceptions Tests**: Custom exceptions, error messages, inheritance

**Coverage:**
- ‚úÖ Exception creation and formatting
- ‚úÖ Error message generation
- ‚úÖ Exception inheritance hierarchy
- ‚úÖ Stack trace preservation

### 8. Integration Tests (`test/integration/`)

End-to-end workflow tests:

- **Complete offline sync workflows**
- **Multi-component interactions**
- **Real-world scenarios**

**Coverage:**
- ‚úÖ Offline data creation and sync
- ‚úÖ Connectivity changes during sync
- ‚úÖ Error recovery workflows
- ‚úÖ Performance under load
- ‚úÖ Concurrent operations

### 9. Performance Tests (`test/performance/`)

Benchmarks and stress tests:

- **Large dataset handling**
- **Memory usage optimization**
- **Concurrent operation performance**

**Coverage:**
- ‚úÖ Large sync queue performance
- ‚úÖ Memory leak detection
- ‚úÖ Concurrent operation handling
- ‚úÖ Resource usage optimization
- ‚úÖ Stress testing scenarios

## üîß Test Utilities

### TestHelpers Class

The `TestHelpers` class provides utilities for creating test data and managing test execution:

```dart
// Create test sync items
final item = TestHelpers.createTestSyncItem(
  id: 'test-item',
  priority: SyncPriority.high,
);

// Generate realistic test data
final data = TestHelpers.generateRealisticTestData(complexity: 2);

// Wait for conditions
await TestHelpers.waitForCondition(
  () => syncManager.syncedItems.isNotEmpty,
  timeout: Duration(seconds: 5),
);

// Measure performance
final stats = await TestHelpers.measurePerformance(
  () => repository.saveAll(entities),
  iterations: 10,
);
```

### Mock Implementations

Pre-built mock implementations for testing:

- `MockSyncManagerImpl`: Full-featured sync manager mock
- `MockConnectivityServiceImpl`: Connectivity service mock
- `MockOfflineRepository`: Repository mock with in-memory storage

### Custom Matchers

Custom test matchers for domain-specific assertions:

```dart
// Test sync item equality (ignoring timestamps)
expect(actualItem, OfflineFirstMatchers.syncItemEquals(expectedItem));

// Test upload state
expect(status, OfflineFirstMatchers.hasUploadState(UploadState.completed));

// Test sync queue ordering
expect(queue, OfflineFirstMatchers.isSyncQueueOrdered());
```

## üìà Coverage Goals

We aim for comprehensive test coverage across all components:

- **Unit Tests**: >90% line coverage
- **Integration Tests**: All major workflows
- **Widget Tests**: All UI components
- **Performance Tests**: Key performance scenarios

### Generating Coverage Reports

```bash
# Generate coverage data
flutter test --coverage

# Generate HTML report
genhtml coverage/lcov.info -o coverage/html

# View report
open coverage/html/index.html
```

## üèÉ‚Äç‚ôÇÔ∏è Running Tests in CI/CD

### GitHub Actions Example

```yaml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Run tests
        run: flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
```

### Test Configuration

Create a `test/dart_test.yaml` file for test configuration:

```yaml
# Test configuration
timeout: 30s
concurrency: 4

tags:
  fast: # Quick unit tests
    timeout: 5s
  slow: # Integration and performance tests
    timeout: 120s
  stress: # Stress tests
    timeout: 300s

platforms:
  - vm
  - chrome
```

## üéØ Best Practices

### Writing Good Tests

1. **Follow AAA Pattern**: Arrange, Act, Assert
2. **Use Descriptive Names**: Test names should explain what is being tested
3. **Test One Thing**: Each test should focus on a single behavior
4. **Use Setup/Teardown**: Properly initialize and clean up test resources
5. **Mock External Dependencies**: Use mocks for external services

### Test Organization

1. **Group Related Tests**: Use `group()` to organize related test cases
2. **Shared Setup**: Use `setUp()` and `tearDown()` for common initialization
3. **Test Data Builders**: Create helper functions for test data creation
4. **Isolate Tests**: Ensure tests don't depend on each other

### Performance Testing

1. **Set Realistic Benchmarks**: Base performance expectations on real-world usage
2. **Test Under Load**: Verify behavior with large datasets
3. **Monitor Memory**: Check for memory leaks in long-running operations
4. **Profile Bottlenecks**: Identify and test performance-critical paths

### Example Test Structure

```dart
group('SyncManager', () {
  late MockSyncManagerImpl syncManager;

  setUp(() async {
    syncManager = MockSyncManagerImpl();
    await syncManager.initialize();
  });

  tearDown(() async {
    await syncManager.dispose();
    syncManager.reset();
  });

  group('Queue Management', () {
    test('should add item to sync queue', () async {
      // Arrange
      final item = TestHelpers.createTestSyncItem();
      
      // Act
      await syncManager.queueForSync(item);
      
      // Assert
      final queue = await syncManager.getSyncQueue();
      expect(queue, hasLength(1));
      expect(queue.first.id, item.id);
    });

    test('should handle empty queue gracefully', () async {
      // Act
      await syncManager.syncNow();
      
      // Assert
      expect(syncManager.syncedItems, isEmpty);
    });
  });
});
```

## üêõ Debugging Test Failures

### Common Issues and Solutions

1. **Async Test Failures**
   ```dart
   // ‚ùå Wrong: Missing await
   test('should complete async operation', () {
     service.performAsyncOperation();
     expect(service.isComplete, true);
   });

   // ‚úÖ Correct: Proper async handling
   test('should complete async operation', () async {
     await service.performAsyncOperation();
     expect(service.isComplete, true);
   });
   ```

2. **Stream Test Failures**
   ```dart
   // ‚ùå Wrong: Not waiting for stream
   test('should emit values', () {
     final stream = service.watchData();
     expect(stream, emits(expectedValue));
   });

   // ‚úÖ Correct: Using expectLater
   test('should emit values', () async {
     final stream = service.watchData();
     await expectLater(stream, emits(expectedValue));
   });
   ```

3. **Mock Setup Issues**
   ```dart
   // ‚ùå Wrong: Incomplete mock setup
   when(() => mockService.getData()).thenReturn([]);

   // ‚úÖ Correct: Complete mock setup
   when(() => mockService.getData()).thenAnswer((_) async => []);
   when(() => mockService.isInitialized).thenReturn(true);
   ```

### Debug Test Output

Run tests with verbose output to see detailed information:

```bash
# Verbose test output
flutter test --reporter expanded

# Debug specific test
flutter test test/path/to/test.dart --reporter expanded
```

## üìû Getting Help

If you encounter issues with tests:

1. **Check Test Documentation**: Review this README and inline documentation
2. **Run Individual Tests**: Isolate failing tests to identify root cause
3. **Check Mock Setup**: Ensure all mocks are properly configured
4. **Verify Test Environment**: Ensure all dependencies are installed
5. **Review Error Messages**: Flutter test provides detailed error information

## ü§ù Contributing Tests

When adding new features:

1. **Write Tests First**: Follow TDD when possible
2. **Update Documentation**: Keep this README current
3. **Add Performance Tests**: Include benchmarks for new features
4. **Test Edge Cases**: Cover error scenarios and boundary conditions
5. **Update CI Configuration**: Ensure new tests run in CI/CD

---

Happy Testing! üéâ